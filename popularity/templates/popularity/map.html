{% extends "base.html" %}
{% load static %}

{% block content %}
{% csrf_token %}
<div class="container-fluid py-4">
    <div class="row mb-4">
        <div class="col-12">
            <h1 class="h2 fw-bold mb-2">Regional Popularity Map</h1>
            <p class="text-muted mb-0">Discover what movies are trending across US regions</p>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-body p-0">
                    <div id="map" style="height: 500px;"></div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card mb-3">
                <div class="card-body">
                    <h5 class="card-title">Update Data</h5>
                    <p class="card-text small text-muted">Refresh popularity data with real purchase information.</p>
                    <button id="update-data-btn" class="btn btn-primary btn-sm">Update Popularity Data</button>
                </div>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">US Regions</h5>
                    <div id="region-list">
                        {% for region in template_data.regions %}
                            <div class="region-item mb-2">
                                <a href="{% url 'region_details' region.id %}" class="text-decoration-none">
                                    <div class="d-flex justify-content-between align-items-center">
                                        <span>{{ region.name }}</span>
                                        <span class="badge bg-primary" data-lat="{{ region.latitude }}" data-lng="{{ region.longitude }}">
                                            View Details
                                        </span>
                                    </div>
                                </a>
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
#Improting leaflet
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const map = L.map('map').setView([39.8283, -98.5795], 4);
    
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© OpenStreetMap contributors'
    }).addTo(map);
    
    const regions = [
        {% for region in template_data.regions %}
        {
            id: {{ region.id }},
            name: "{{ region.name }}",
            lat: {{ region.latitude }},
            lng: {{ region.longitude }},
            zoom: {{ region.zoom_level }}
        }{% if not forloop.last %},{% endif %}
        {% endfor %}
    ];
    
    const markers = [];
    
    regions.forEach(function(region) {
        const marker = L.marker([region.lat, region.lng]).addTo(map);
        
        const popupContent = `
            <div class="text-center">
                <h6>${region.name}</h6>
                <a href="/popularity/region/${region.id}/" class="btn btn-primary btn-sm">View Trending Movies</a>
            </div>
        `;
        
        marker.bindPopup(popupContent);
        markers.push(marker);
    });
    
    if (regions.length > 0) {
        const group = new L.featureGroup(markers);
        map.fitBounds(group.getBounds().pad(0.1));
    }
    
    // Handle update data button
    document.getElementById('update-data-btn').addEventListener('click', function() {
        const btn = this;
        const originalText = btn.textContent;
        btn.textContent = 'Updating...';
        btn.disabled = true;
        
        fetch('/popularity/update-data/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'Content-Type': 'application/json',
            },
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                btn.textContent = 'Updated Successfully!';
                setTimeout(() => {
                    location.reload();
                }, 1500);
            } else {
                btn.textContent = 'Update Failed';
                btn.disabled = false;
            }
        })
        .catch(error => {
            console.error('Error:', error);
            btn.textContent = 'Update Failed';
            btn.disabled = false;
        });
    });
});
</script>

<style>
.region-item:hover {
    background-color: #f8f9fa;
    border-radius: 5px;
    padding: 5px;
}
</style>
{% endblock content %}